app:
  description: ''
  icon: ğŸ¤–
  icon_background: '#FFEAD5'
  mode: workflow
  name: sillytavern producer
  use_icon_as_answer_icon: false
dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: langgenius/volcengine_maas:0.0.25@69d479387c274399cdf967854fa2eab8b2ece3c1b28c702724402913639dcc24
kind: app
version: 0.3.1
workflow:
  conversation_variables: []
  environment_variables:
  - description: ''
    id: ad8e4324-4d23-488a-b49c-5b80905cd285
    name: S3_REGION
    selector:
    - env
    - S3_REGION
    value: cn-guangzhou
    value_type: string
  - description: ''
    id: eeda4e5d-bfb0-47f3-81df-b7afb5298e85
    name: S3_BUCKET_NAME
    selector:
    - env
    - S3_BUCKET_NAME
    value: silly-tavern
    value_type: string
  - description: ''
    id: 498ede88-7ca1-494c-ab34-7ebc9b887243
    name: S3_ENDPOINT
    selector:
    - env
    - S3_ENDPOINT
    value: https://tos-s3-cn-guangzhou.volces.com
    value_type: string
  - description: ''
    id: 16daada0-6be7-4773-bfc0-25889b473af6
    name: S3_SECRET_ACCESS_KEY
    selector:
    - env
    - S3_SECRET_ACCESS_KEY
    value: Wm1FNE9XRXdOREV5WWpZMk5HWTJPVGszT1ROaFlURXhPRGcxWmpRMlkyRQ==
    value_type: secret
  - description: tos ak
    id: d94b3436-aca6-4230-9b18-0f880809472a
    name: S3_ACCESS_KEY_ID
    selector:
    - env
    - S3_ACCESS_KEY_ID
    value: AKLTNGVkMDM1YTAzZTY0NDE4MjgyMmUxN2VlZGI5ZDBiOWE
    value_type: secret
  features:
    file_upload:
      allowed_file_extensions:
      - .JPG
      - .JPEG
      - .PNG
      - .GIF
      - .WEBP
      - .SVG
      allowed_file_types:
      - image
      allowed_file_upload_methods:
      - local_file
      - remote_url
      enabled: false
      fileUploadConfig:
        audio_file_size_limit: 50
        batch_count_limit: 5
        file_size_limit: 15
        image_file_size_limit: 10
        video_file_size_limit: 100
        workflow_file_upload_limit: 10
      image:
        enabled: false
        number_limits: 3
        transfer_methods:
        - local_file
        - remote_url
      number_limits: 3
    opening_statement: ''
    retriever_resource:
      enabled: true
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions: []
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
      language: ''
      voice: ''
  graph:
    edges:
    - data:
        isInLoop: false
        sourceType: llm
        targetType: llm
      id: 1755013697903-source-1755333812200-target
      selected: false
      source: '1755013697903'
      sourceHandle: source
      target: '1755333812200'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: llm
        targetType: llm
      id: 1755013697903-source-1755334965838-target
      source: '1755013697903'
      sourceHandle: source
      target: '1755334965838'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: llm
        targetType: llm
      id: 1755333812200-source-1755345336430-target
      source: '1755333812200'
      sourceHandle: source
      target: '1755345336430'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: llm
        targetType: llm
      id: 1755334965838-source-1755345336430-target
      source: '1755334965838'
      sourceHandle: source
      target: '1755345336430'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: llm
        targetType: code
      id: 1755345336430-source-1755349739661-target
      source: '1755345336430'
      sourceHandle: source
      target: '1755349739661'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: code
      id: 1755394568320-source-17553986203320-target
      source: '1755394568320'
      sourceHandle: source
      target: '17553986203320'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: start
        targetType: if-else
      id: 1754406660427-source-1755399127965-target
      source: '1754406660427'
      sourceHandle: source
      target: '1755399127965'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: llm
      id: 1755399127965-false-1755013697903-target
      source: '1755399127965'
      sourceHandle: 'false'
      target: '1755013697903'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: code
      id: 1755399127965-true-1755394568320-target
      source: '1755399127965'
      sourceHandle: 'true'
      target: '1755394568320'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: end
      id: 17553986203320-source-1755399316678-target
      source: '17553986203320'
      sourceHandle: source
      target: '1755399316678'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: end
      id: 1755349739661-source-1754408356942-target
      source: '1755349739661'
      sourceHandle: source
      target: '1754408356942'
      targetHandle: target
      type: custom
      zIndex: 0
    nodes:
    - data:
        desc: ''
        selected: false
        title: å¼€å§‹
        type: start
        variables:
        - label: input
          max_length: 256
          options: []
          required: true
          type: text-input
          variable: input
        - label: debug
          max_length: 48
          options: []
          required: true
          type: text-input
          variable: debug
      height: 115
      id: '1754406660427'
      position:
        x: -474.16034006134555
        y: 316.0701915835626
      positionAbsolute:
        x: -474.16034006134555
        y: 316.0701915835626
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        desc: ''
        outputs:
        - value_selector:
          - '1755349739661'
          - url
          value_type: string
          variable: url
        selected: false
        title: ç»“æŸ
        type: end
      height: 90
      id: '1754408356942'
      position:
        x: 1647.1713568829925
        y: 603.0512675380639
      positionAbsolute:
        x: 1647.1713568829925
        y: 603.0512675380639
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: ''
        model:
          completion_params:
            temperature: 0.7
          mode: chat
          name: Doubao-1.5-pro-256k
          provider: langgenius/volcengine_maas/volcengine_maas
        prompt_template:
        - id: eabda7ee-2ed3-49a3-ba93-ad70eab5ccd7
          role: system
          text: 'äº‹ä»¶æ˜¯æ—¢å­˜ç¬¦å·ç§©åºä¸­çªç„¶å‡ºç°çš„æ ¹æœ¬æ€§æ–­è£‚ï¼Œå®ƒé¢ è¦†äººä»¬å¯¹ç°å®çš„å¸¸è§„è®¤çŸ¥ã€‚äº‹ä»¶ä¸æ˜¯ç®€å•çš„â€œå‘ç”Ÿâ€ï¼Œè€Œæ˜¯ï¼šåˆ›ä¼¤æ€§çš„ï¼šæ‰“ç ´æ—¥å¸¸ç”Ÿæ´»çš„å¹³æ»‘è¡¨é¢ï¼Œæš´éœ²å‡ºç°å®ä¸­çš„çŸ›ç›¾ï¼ˆå¦‚â€œ9Â·11â€äº‹ä»¶æš´éœ²äº†å…¨çƒåŒ–æ—¶ä»£çš„è„†å¼±æ€§ï¼‰ã€‚ä¸å¯åŒ–çº¦çš„ï¼šæ— æ³•ç”¨ç°æœ‰æ„è¯†å½¢æ€æ¡†æ¶å®Œå…¨è§£é‡Šï¼ˆä¾‹å¦‚ï¼Œæ³•å›½å¤§é©å‘½å¯¹å›ä¸»åˆ¶åˆæ³•æ€§çš„å½»åº•å¦å®šï¼‰ã€‚ç”Ÿæˆæ€§çš„ï¼šäº‹ä»¶åˆ›é€ æ–°çš„å¯èƒ½æ€§ç©ºé—´ï¼Œé‡å¡‘ä¸»ä½“ä¸ä¸–ç•Œçš„å…³ç³»ï¼ˆå¦‚ç§‘å­¦é©å‘½ä¸­çš„èŒƒå¼è½¬ç§»ï¼‰ã€‚

            ä½ æ˜¯ä¸€åç¤¾ä¼šæ´å¯Ÿå‹è·‘å›¢è®¾è®¡å¸ˆï¼Œäº†è§£å¤ä»Šä¸­å¤–å„ç§å†å²æ€§äº‹ä»¶ï¼Œæ“…é•¿å°†æŠ½è±¡ç¤¾ä¼šè§„åˆ™è½¬åŒ–ä¸ºå¯æ“ä½œçš„æ¸¸æˆç³»ç»Ÿã€‚

            åŸºäºç”¨æˆ·æä¾›çš„æ ¸å¿ƒæ–‡æœ¬ï¼Œè®¾è®¡å…·è±¡åŒ–ç¤¾ä¼šçŸ›ç›¾çš„æ²‰æµ¸å¼è·‘å›¢å‰§æœ¬ã€‚

            è¦æ±‚ç”Ÿæˆå‰§æœ¬å¤§çº²ï¼Œäº¤ä»£æ•…äº‹èƒŒæ™¯ã€‚

            åŸºäºä¸Šè¿°æ–‡æœ¬å’Œç”¨æˆ·è¾“å…¥ï¼Œä½ å°†åˆ›é€ ä¸€ä¸ªäº‹ä»¶æ€§çš„è·‘å›¢å‰§æœ¬'
        - id: 6095b5f6-1827-44f4-b204-bb9cddc3dfa6
          role: user
          text: "ä»¥ä¸‹æ˜¯ç”¨æˆ·æä¾›çš„æ ¸å¿ƒæ–‡æœ¬\n {{#1754406660427.input#}}\næ ¹æ®æç‚¼çš„å…³é”®æ€æƒ³å†…æ ¸ï¼Œç”Ÿæˆå‰§æœ¬å¤§çº²ï¼Œäº¤ä»£æ•…äº‹èƒŒæ™¯"
        selected: false
        structured_output:
          schema:
            additionalProperties: false
            properties:
              background:
                description: æ•…äº‹èƒŒæ™¯ï¼ŒåŒ…æ‹¬æ ¸å¿ƒå†²çªå’Œå¾…è§£å†³çš„ç›®æ ‡ï¼Œè¿™é‡Œéå¸¸é‡è¦
                type: string
              events:
                description: å‰§æœ¬çš„å…³é”®æ”¯çº¿äº‹ä»¶ï¼Œéçº¿æ€§å™äº‹ï¼Œè¦æ±‚äº‹ä»¶ä¸å°‘äº6ä¸ª
                items:
                  type: string
                type: array
              name:
                description: è·‘å›¢å‰§æœ¬åç§°
                type: string
            required:
            - name
            - background
            - events
            type: object
        structured_output_enabled: true
        title: å‰§æœ¬æ ¸å¿ƒ
        type: llm
        variables: []
        vision:
          enabled: false
      height: 89
      id: '1755013697903'
      position:
        x: 223.0886076360227
        y: 609.857142857143
      positionAbsolute:
        x: 223.0886076360227
        y: 609.857142857143
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: ''
        model:
          completion_params:
            temperature: 0.7
          mode: chat
          name: ' Doubao-Seed-1.6-flash'
          provider: langgenius/volcengine_maas/volcengine_maas
        prompt_template:
        - id: 90f34ba4-b441-4c7b-ae5c-aca2b51548ec
          role: system
          text: ä½ æ˜¯ä¸€ä¸ªæ“…é•¿å¡‘é€ è§’è‰²çš„å°è¯´å®¶ï¼Œæ“…é•¿æ ¹æ®æä¾›çš„å‰§æœ¬å¤§çº²å’Œå…³é”®äº‹ä»¶ï¼Œç”Ÿæˆä¸ªæ€§é²œæ˜ï¼Œæ·±åˆ»äººç‰©åŸºæœ¬ç‰¹ç‚¹ã€å¹¶åŸºäºæ­¤ç”Ÿæˆç®€ä»‹ã€‚
        - id: ec70c77a-6d1d-46bb-938c-a82abf7cfeca
          role: user
          text: 'æ•…äº‹èƒŒæ™¯{{#1755013697903.structured_output.background#}}

            ä¸»è¦äº‹ä»¶{{#1755013697903.structured_output.events#}}åŸºäºæ­¤ç”Ÿæˆå…·æœ‰ä»£è¡¨æ€§äººç‰©è§’è‰²å’Œç”Ÿå¹³ç®€ä»‹ï¼Œä»¥åŠä»–æ˜¯å¦‚ä½•è¢«å·å…¥è¿™ä¸ªæ•…äº‹ä¸­çš„

            è¦æ±‚å¦‚ä¸‹

            ç¬¬ä¸€æ­¥ï¼Œç”Ÿæˆä¸€ä¸ªä¸»æ§è§’è‰²ï¼Œè·‘å›¢æ¸¸æˆé€šè¿‡ä¸»æ§è§’è‰²è¿›è¡Œçš„ç¬¬ä¸€äººç§°

            ç¬¬äºŒæ­¥ï¼Œæ ¹æ®æ•…äº‹èƒŒæ™¯å’Œä¸»è¦äº‹ä»¶ç”Ÿæˆä»–è€…ï¼Œæ— æ³•çœ‹åˆ°å…¶å¿ƒç†æ´»åŠ¨ï¼Œ3åˆ°5äºº

            æ¯ä¸ªäººçš„ç®€ä»‹å­—æ•°è¶…è¿‡200å­—

            '
        selected: false
        structured_output:
          schema:
            additionalProperties: false
            properties:
              main_character:
                additionalProperties: false
                description: ä¸»æ§è§’è‰²
                properties:
                  description:
                    description: äººç‰©ç®€ä»‹ã€ç”Ÿå¹³ï¼Œæ˜¯å¦‚ä½•è¿›å…¥è¿™ä¸ªæ•…äº‹ä¸­çš„
                    type: string
                  name:
                    description: åç§°
                    type: string
                required:
                - name
                - description
                type: object
              others:
                description: å…¶ä»–è§’è‰²çš„åˆ—è¡¨
                items:
                  additionalProperties: false
                  properties:
                    description:
                      description: äººç‰©ç®€ä»‹ã€ç”Ÿå¹³ï¼Œæ˜¯å¦‚ä½•è¿›å…¥è¿™ä¸ªæ•…äº‹ä¸­çš„
                      type: string
                    name:
                      description: åç§°
                      type: string
                  required:
                  - name
                  - description
                  type: object
                type: array
            required:
            - main_character
            - others
            type: object
        structured_output_enabled: true
        title: ç”Ÿæˆè§’è‰²
        type: llm
        variables: []
        vision:
          enabled: false
      height: 89
      id: '1755333812200'
      position:
        x: 581.4367021833149
        y: 374.29383414132263
      positionAbsolute:
        x: 581.4367021833149
        y: 374.29383414132263
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: ''
        model:
          completion_params:
            temperature: 0.7
          mode: chat
          name: ' Doubao-Seed-1.6-flash'
          provider: langgenius/volcengine_maas/volcengine_maas
        prompt_template:
        - id: ce42af0f-312c-4b39-86b6-c1f77c6550a8
          role: system
          text: 'è¦æ±‚

            æ ¹æ®æä¾›çš„èƒŒæ™¯ä¿¡æ¯å’Œå…·ä½“äº‹ä»¶ï¼Œå¯¹å…·ä½“äº‹ä»¶è¿›è¡Œæ‰©å†™ï¼Œè¡¥å……æ›´å¤šç¬¦åˆé€»è¾‘çš„ç»†èŠ‚ã€‚

            äº‹ä»¶æ‰©å†™çš„é€»è¾‘ã€æ–‡é£è¦ä¿æŒä¸€è‡´ï¼Œè¦æœ‰æ–‡é‡‡'
        - id: 1baf3332-6f65-4994-b59d-b528cf2ea05c
          role: user
          text: 'èƒŒæ™¯ä¿¡æ¯{{#1755013697903.structured_output.background#}}ï¼Œäº‹ä»¶ {{#1755013697903.structured_output.events#}}

            è¦æ±‚

            å¯¹æ¯æ¡äº‹ä»¶è¿›è¡Œæ‰©å†™ï¼Œæ‰©å†™åçš„æ•…äº‹è¦æœ‰ç»†èŠ‚ï¼Œå­—æ•°è¶…è¿‡300å­—

            å¯¹æ‰©å†™åçš„äº‹ä»¶è¿›è¡Œå…³é”®è¯æ€»ç»“ï¼Œ3åˆ°5ä¸ªå…³é”®è¯ï¼Œæ¯ä¸ªå…³é”®è¯3åˆ°6ä¸ªå­—

            æ‰©å†™å†…å®¹ï¼Œè¦æœ‰å°è¯´æå†™æ•…äº‹çš„é‚£ç§æ„Ÿè§‰'
        selected: false
        structured_output:
          schema:
            additionalProperties: false
            properties:
              events:
                description: æ‰©å†™åäº‹ä»¶åˆ—è¡¨
                items:
                  additionalProperties: false
                  properties:
                    key:
                      description: è¯¥äº‹ä»¶çš„å…³é”®è¯åˆ—è¡¨ï¼Œç²¾ç®€ï¼Œ3åˆ°6ä¸ªå­—ï¼Œåˆ—è¡¨é•¿åº¦ä¸Šé™æ˜¯5ä¸ª
                      items:
                        type: string
                      type: array
                    msg:
                      description: äº‹ä»¶çš„å†…å®¹ï¼Œè¦æœ‰ç»†èŠ‚ï¼Œ300å­—åˆ°500å­—
                      type: string
                  required:
                  - key
                  - msg
                  type: object
                type: array
            required:
            - events
            type: object
        structured_output_enabled: true
        title: åœºæ™¯æ‰©å†™
        type: llm
        variables: []
        vision:
          enabled: false
      height: 89
      id: '1755334965838'
      position:
        x: 581.4367021833149
        y: 784.1428571428573
      positionAbsolute:
        x: 581.4367021833149
        y: 784.1428571428573
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: ''
        model:
          completion_params:
            temperature: 0.7
          mode: chat
          name: ' Doubao-Seed-1.6-flash'
          provider: langgenius/volcengine_maas/volcengine_maas
        prompt_template:
        - id: 96bbb6f3-5ab5-49e7-b915-4b730cf890fb
          role: system
          text: 'æ ¹æ®ç»™åˆ°çš„èƒŒæ™¯ä¿¡æ¯å’Œä¸»è¦äº‹ä»¶ã€ç”Ÿæˆæ•…äº‹çš„å¼•å­ï¼Œè¦æ³¨é‡èƒŒæ™¯ä¿¡æ¯çš„ä»‹ç»ï¼Œç•¥æœ‰æ–‡å­¦å°è¯´çš„é£æ ¼ï¼Œæ³¨é‡ç¯å¢ƒçš„æå†™ã€æ°”æ°›çš„çƒ˜æ‰˜ã€‚

            åœ¨å¤šä¸ªä¸»è¦äº‹ä»¶ä¸­é€‰å–é€‚åˆçš„äº‹ä»¶ä½œä¸ºå¼•å­'
        - id: 8415d6be-119a-4b22-a995-1aaa86509529
          role: user
          text: "èƒŒæ™¯ä¿¡æ¯{{#1755013697903.structured_output.background#}} \nä¸»è¦äº‹ä»¶   {{#1755334965838.structured_output.events#}}\n\
            ä¸»è§’{{#1755333812200.structured_output.main_character#}}\nç”Ÿæˆ2åˆ°3æ¡å‰§æœ¬çš„ç¬¬ä¸€å¹•ï¼Œç”¨æˆ·éœ€è¦æ‰®æ¼”ä¸»æ§è§’è‰²<main_character>,ä½œä¸ºå‰§æƒ…å‘å±•çš„äº²å†è€…ï¼Œè¦æœ‰ç»†èŠ‚çš„æå†™ï¼Œä½œä¸ºå‰§æœ¬çš„ç”Ÿæˆè€…ï¼Œä½¿ç”¨ä½ æ¥æŒ‡ä»£ç©å®¶æ‰®æ¼”çš„è§’è‰²ï¼Œå¢åŠ æ²‰æµ¸æ„Ÿ"
        selected: false
        structured_output:
          schema:
            additionalProperties: false
            properties:
              firstmsg:
                description: ç¬¬ä¸€å¹•çš„æ–‡æœ¬ï¼Œå¯ä»¥æœ‰å¤šä¸ªï¼Œæä¾›ç»™ç©å®¶é€‰æ‹©
                items:
                  type: string
                type: array
            required:
            - firstmsg
            type: object
        structured_output_enabled: true
        title: ç¬¬ä¸€å¹•
        type: llm
        variables: []
        vision:
          enabled: false
      height: 89
      id: '1755345336430'
      position:
        x: 974.0940900477669
        y: 609.857142857143
      positionAbsolute:
        x: 974.0940900477669
        y: 609.857142857143
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        code: "import json\nfrom dataclasses import asdict, dataclass\nfrom typing\
          \ import List, Dict, Any, Optional\nfrom datetime import datetime\nimport\
          \ hmac\nimport hashlib\n\nimport os\nimport requests\nimport urllib.parse\n\
          \n#é…’é¦†æ•°æ®\n@dataclass\nclass RegexScript: #æ­£åˆ™\n    id: str\n    scriptName:\
          \ str\n    findRegex: str\n    replaceString: str\n    trimStrings: List[str]\n\
          \    placement: List[int]\n    disabled: bool\n    markdownOnly: bool\n\
          \    promptOnly: bool\n    runOnEdit: bool\n    substituteRegex: int\n \
          \   minDepth: Optional[int] = None\n    maxDepth: Optional[int] = None\n\
          \n@dataclass\nclass CharacterBookEntryExtensions:  # ä¸–ç•Œä¹¦å•ä¸€æ¡ç›®çš„ä¿¡æ¯ï¼Œæœ‰å¾ˆå¤šç”¨ä¸ä¸Š\n\
          \    position: int\n    exclude_recursion: bool\n    display_index: int\n\
          \    probability: int\n    useProbability: bool\n    depth: int\n    selectiveLogic:\
          \ int\n    group: str\n    group_override: bool\n    group_weight: int\n\
          \    prevent_recursion: bool\n    delay_until_recursion: bool\n    scan_depth:\
          \ Optional[int] = None\n    match_whole_words: bool = False\n    use_group_scoring:\
          \ bool = False\n    case_sensitive: bool = False\n    automation_id: str\
          \ = \"\"\n    role: int = 0\n    vectorized: bool = False\n    sticky: int\
          \ = 0\n    cooldown: int = 0\n    delay: int = 0\n    match_persona_description:\
          \ bool = False\n    match_character_description: bool = False\n    match_character_personality:\
          \ bool = False\n    match_character_depth_prompt: bool = False\n    match_scenario:\
          \ bool = False\n    match_creator_notes: bool = False\n\n@dataclass\nclass\
          \ CharacterBookEntry:\n    id: int\n    keys: List[str] #å…³é”®è¯\n    secondary_keys:\
          \ List[str] #å¯é€‰è¿‡æ»¤å™¨(stæ–‡æœ¬æè¿°å¦‚æ­¤)\n    comment: str   #æè¿°\n    content: str \
          \  #æ¿€æ´»åæ›¿æ¢çš„æ–‡æœ¬\n    constant: bool  # æ˜¯å¦æ°¸ä¹…æ¿€æ´»,ä¸ºtrueå°±ä¸ç®¡æ­£åˆ™æ˜¯å¦ç”Ÿæ•ˆï¼Œéƒ½ä¼šæ’å…¥ä¸–ç•Œä¹¦\n    selective:\
          \ bool #æ°¸ä¹…ä¸ºtrueï¼Ÿä¸çŸ¥é“å«ä¹‰\n    insertion_order: int  #åŒä¸€ä¸ªæ’å…¥ä½ç½®çš„é¡ºåºï¼Œæ•°å­—å°çš„åœ¨ä¸Šé¢\n \
          \   enabled: bool    # æ˜¯å¦åº”ç”¨\n    position: str    # å‡ ä¸ªä½ç½®æšä¸¾ after_char\n\
          \    use_regex: bool  # å¤§å¤šä¸ºtrue\n    #extensions: CharacterBookEntryExtensions\n\
          \n@dataclass\nclass CharacterBook:\n    entries: List[CharacterBookEntry]\n\
          \    name: str\n\n@dataclass\nclass Extensions:\n    talkativeness: str\n\
          \    fav: bool\n    world: str\n    depth_prompt: Dict[str, Any]\n    regex_scripts:\
          \ List[RegexScript]\n\n@dataclass\nclass Data:\n    name: str\n    first_mes:\
          \ str\n    alternate_greetings: List[str]\n    #extensions: Extensions\n\
          \    group_only_greetings: List[str]\n    character_book: CharacterBook\n\
          \n@dataclass\nclass CharaCardV3:\n    name: str\n    first_mes: str\n  \
          \  talkativeness: str\n    spec: str\n    spec_version: str\n    data: Data\n\
          \    create_date: str\n\n#è‡ªå®šä¹‰æ•°æ®\n@dataclass\nclass role:\n    name: str\n\
          \    desc: str\n\n@dataclass\nclass ent:\n    key: List[str]\n    msg: str\n\
          \ndef main(nameArg: str, maincharacterArg: dict, othersArg: list, eventsArg:\
          \ list, firstmsgArg: list, S3_REGION: str, S3_BUCKET_NAME: str, S3_ENDPOINT:\
          \ str, S3_SECRET_ACCESS_KEY, S3_ACCESS_KEY_ID) -> dict:\n    name=nameArg\n\
          \    maincharacter = role(\n        name=maincharacterArg['name'],\n   \
          \     desc=maincharacterArg['description']\n    )\n\n    others = [role(name=o['name'],\
          \ desc=o['description']) for o in othersArg]\n    events =[]\n    #events\
          \ = [ent(key=e['key'], msg=e['msg']) for e in eventsArg]\n    firmsg = firstmsgArg\n\
          \n        #ç”Ÿæˆä¸–ç•Œä¹¦\n    i = 0\n    cbes:List[CharacterBookEntry] = []\n  \
          \  cbe = CharacterBookEntry(\n            id=i,\n            keys=[],\n\
          \            secondary_keys=[],\n            comment=\"è§’è‰²èƒŒæ™¯\",\n       \
          \     content=maincharacter.name+\":\"+maincharacter.desc,\n           \
          \ constant=True,\n            selective=True,\n            insertion_order=100,\n\
          \            enabled=True,\n            position=\"after_char\",\n     \
          \       use_regex=True,\n            )\n    cbes.append(cbe)\n    i = i\
          \ + 1\n    for other in others:\n        cbes.append(CharacterBookEntry(\n\
          \            id=i,\n            keys=[other.name],\n            secondary_keys=[],\n\
          \            comment=\"è§’è‰²èƒŒæ™¯\",\n            content=other.name+\":\"+other.desc,\n\
          \            constant=True,\n            selective=True,\n            insertion_order=100,\n\
          \            enabled=True,\n            position=\"after_char\",\n     \
          \       use_regex=True,\n        ))\n        i = i + 1\n    for event in\
          \ events:\n        cbes.append(CharacterBookEntry(\n            id=i,\n\
          \            keys=event.key,\n            secondary_keys=[],\n         \
          \   comment=f\"äº‹ä»¶{event.key.get('0', 'æœªçŸ¥')}\",\n            content=event.msg,\n\
          \            constant=True,\n            selective=True,\n            insertion_order=100,\n\
          \            enabled=True,\n            position=\"after_char\",\n     \
          \       use_regex=True,\n        ))\n        i = i + 1\n    \n    data =\
          \ Data(\n        name=name,\n        first_mes=firmsg[0],\n        alternate_greetings=[msg\
          \ for msg in firmsg[1:]],\n        group_only_greetings=[],\n        character_book=CharacterBook(\n\
          \            entries=cbes,\n            name=f\"ä¸–ç•Œä¹¦:{name}\"\n        ),\n\
          \    )\n    current_time = datetime.now()\n    formatted_time = current_time.strftime(\"\
          %Y-%m-%d %H:%M:%S\")\n    card = CharaCardV3(\n        name=name,\n    \
          \    first_mes=firmsg[0],\n        talkativeness=\"0.5\",\n        spec=\"\
          chara_card_v3\",\n        spec_version=\"3.0\",\n        data=data,\n  \
          \      create_date= formatted_time\n    )\n    s = json.dumps(asdict(card),\
          \ ensure_ascii=False)\n    # ret: Output = {\n    #     \"name\": name,\n\
          \    #     \"first_mes\": firmsg[0],\n    #     \"talkativeness\":\"0.5\"\
          ,\n    #     \"spec\":\"chara_card_v3\",\n    #     \"spec_version\":\"\
          3.0\",\n    #     \"data\":s,\n    #     \"create_date\": formatted_time,\n\
          \    # }\n    access_key = S3_ACCESS_KEY_ID\n    secret_key = S3_SECRET_ACCESS_KEY\n\
          \    endpoint = S3_ENDPOINT\n    bucket = S3_BUCKET_NAME\n    region = S3_REGION\n\
          \    if access_key is None:\n        raise EnvironmentError(f\"ç¯å¢ƒå˜é‡æœªè®¾ç½®æˆ–ä¸ºç©º\"\
          )\n    s3 = S3Client(\n        access_key=access_key,\n        secret_key=secret_key,\n\
          \        endpoint=endpoint,\n        bucket=bucket,\n        region=\"cn-guangzhou\"\
          ,\n    )\n    \n    data_bytes = s.encode('utf-8') \n    s3_key = f\"card/{name}_{datetime.utcnow().isoformat()}.json\"\
          \n    # ä¸Šä¼ å¹¶è·å–URL\n    if s3.put_object(s3_key, data_bytes):\n        url\
          \ = (s3.generate_presigned_url(s3_key))\n    else:\n        raise RuntimeError(\"\
          S3 upload failed\")\n    return {\n        \"url\": url\n    }\n\n\nclass\
          \ S3Client:\n    def __init__(self, access_key, secret_key, endpoint, bucket,\
          \ region=\"cn-guangzhou\"):\n        self.access_key = access_key\n    \
          \    self.secret_key = secret_key\n        self.bucket = bucket\n      \
          \  self.endpoint = endpoint.replace('https://', '').replace('http://', '')\n\
          \        self.service = 's3'\n        self.region = region or \"cn-guangzhou\"\
          \n\n    def _get_signature_key(self, date_stamp):\n        k_date = hmac.new(f\"\
          AWS4{self.secret_key}\".encode('utf-8'), date_stamp.encode('utf-8'), hashlib.sha256).digest()\n\
          \        k_region = hmac.new(k_date, self.region.encode('utf-8'), hashlib.sha256).digest()\n\
          \        k_service = hmac.new(k_region, self.service.encode('utf-8'), hashlib.sha256).digest()\n\
          \        return hmac.new(k_service, b\"aws4_request\", hashlib.sha256).digest()\n\
          \n    def _build_canonical_request(self, method, key, headers, signed_headers,\
          \ payload_hash):\n        # 1. HTTPæ–¹æ³•\n        canonical_request = f\"{method}\\\
          n\"\n        \n        # 2. CanonicalURI (URLç¼–ç è·¯å¾„)\n        canonical_request\
          \ += f\"/{urllib.parse.quote(key, safe='/')}\\n\"\n        \n        # 3.\
          \ CanonicalQueryString (ç©ºå­—ç¬¦ä¸²ï¼Œæ— æŸ¥è¯¢å‚æ•°)\n        canonical_request += \"\\n\"\
          \n        \n        # 4. CanonicalHeaders (æŒ‰å°å†™å­—æ®µåæ’åº)\n        sorted_headers\
          \ = sorted(headers.items(), key=lambda x: x[0].lower())\n        for header_name,\
          \ header_value in sorted_headers:\n            canonical_request += f\"\
          {header_name.lower()}:{header_value}\\n\"\n        \n        # 5. SignedHeaders\
          \ (æ’åºçš„å¤´éƒ¨åˆ—è¡¨)\n        canonical_request += \"\\n\"\n        canonical_request\
          \ += signed_headers + \"\\n\"\n        \n        # 6. HashedPayload\n  \
          \      canonical_request += payload_hash\n        \n        return canonical_request\n\
          \n    def _build_auth_header(self, method, key, headers, signed_headers,\
          \ payload_hash):\n        datestamp = datetime.utcnow().strftime('%Y%m%d')\n\
          \        amz_date = headers['x-amz-date']\n        \n        # 1. æ„å»ºCanonicalRequest\n\
          \        canonical_request = self._build_canonical_request(\n          \
          \  method, key, headers, signed_headers, payload_hash\n        )\n     \
          \   \n        # 2. åˆ›å»ºè¦ç­¾åçš„å­—ç¬¦ä¸²\n        algorithm = 'AWS4-HMAC-SHA256'\n \
          \       credential_scope = f\"{datestamp}/{self.region}/{self.service}/aws4_request\"\
          \n        \n        string_to_sign = (\n            f\"{algorithm}\\n\"\n\
          \            f\"{amz_date}\\n\"\n            f\"{credential_scope}\\n\"\n\
          \            f\"{hashlib.sha256(canonical_request.encode('utf-8')).hexdigest()}\"\
          \n        )\n        \n        # 3. è®¡ç®—ç­¾å\n        signing_key = self._get_signature_key(datestamp)\n\
          \        signature = hmac.new(signing_key, string_to_sign.encode('utf-8'),\
          \ hashlib.sha256).hexdigest()\n        \n        return (\n            f\"\
          {algorithm} Credential={self.access_key}/{credential_scope}, \"\n      \
          \      f\"SignedHeaders={signed_headers}, Signature={signature}\"\n    \
          \    )\n\n    def put_object(self, key, data, content_type='application/json'):\n\
          \        # å‡†å¤‡è¯·æ±‚å‚æ•°\n        host = f\"{self.bucket}.{self.endpoint}\"\n \
          \       url = f\"https://{host}/{urllib.parse.quote(key, safe='/')}\"\n\
          \        amz_date = datetime.utcnow().strftime('%Y%m%dT%H%M%SZ')\n     \
          \   payload_hash = hashlib.sha256(data).hexdigest()\n        \n        #\
          \ å¿…é¡»åŒ…å«æ‰€æœ‰ç­¾åå¤´\n        headers = {\n            'Host': host,\n          \
          \  'Content-Type': content_type,\n            'x-amz-date': amz_date,\n\
          \            'x-amz-content-sha256': payload_hash\n        }\n        \n\
          \        # æ’åºçš„ç­¾åå¤´éƒ¨åˆ—è¡¨\n        signed_headers = ';'.join(sorted(header.lower()\
          \ for header in headers.keys()))\n        \n        # ç”Ÿæˆè®¤è¯å¤´\n        auth_header\
          \ = self._build_auth_header(\n            'PUT', key, headers, signed_headers,\
          \ payload_hash\n        )\n        headers['Authorization'] = auth_header\n\
          \        \n        # å‘é€è¯·æ±‚\n        response = requests.put(url, data=data,\
          \ headers=headers)\n        return response.status_code == 200\n\n    def\
          \ generate_presigned_url(self, key, expires=3600):\n        host = f\"{self.bucket}.{self.endpoint}\"\
          \n        datestamp = datetime.utcnow().strftime('%Y%m%d')\n        amz_date\
          \ = datetime.utcnow().strftime('%Y%m%dT%H%M%SZ')\n        credential_scope\
          \ = f\"{datestamp}/{self.region}/s3/aws4_request\"\n        \n        #\
          \ æŸ¥è¯¢å‚æ•°\n        query_params = {\n            'X-Amz-Algorithm': 'AWS4-HMAC-SHA256',\n\
          \            'X-Amz-Credential': f\"{self.access_key}/{credential_scope}\"\
          ,\n            'X-Amz-Date': amz_date,\n            'X-Amz-Expires': str(expires),\n\
          \            'X-Amz-SignedHeaders': 'host',\n        }\n        \n     \
          \   # è§„èŒƒæŸ¥è¯¢å­—ç¬¦ä¸²\n        canonical_querystring = '&'.join(\n            f\"\
          {k}={urllib.parse.quote(v, safe='')}\" \n            for k, v in sorted(query_params.items())\n\
          \        )\n        \n        # è§„èŒƒè¯·æ±‚\n        canonical_request = (\n  \
          \          f\"GET\\n\"\n            f\"/{urllib.parse.quote(key, safe='/')}\\\
          n\"\n            f\"{canonical_querystring}\\n\"\n            f\"host:{host}\\\
          n\\n\"\n            f\"host\\n\"\n            f\"UNSIGNED-PAYLOAD\"\n  \
          \      )\n        \n        # åˆ›å»ºè¦ç­¾åçš„å­—ç¬¦ä¸²\n        string_to_sign = (\n  \
          \          f\"AWS4-HMAC-SHA256\\n\"\n            f\"{amz_date}\\n\"\n  \
          \          f\"{credential_scope}\\n\"\n            f\"{hashlib.sha256(canonical_request.encode('utf-8')).hexdigest()}\"\
          \n        )\n        \n        # è®¡ç®—ç­¾å\n        signing_key = self._get_signature_key(datestamp)\n\
          \        signature = hmac.new(signing_key, string_to_sign.encode('utf-8'),\
          \ hashlib.sha256).hexdigest()\n        \n        return f\"https://{host}/{urllib.parse.quote(key,\
          \ safe='/')}?{canonical_querystring}&X-Amz-Signature={signature}\"\n\n\n"
        code_language: python3
        desc: ''
        outputs:
          url:
            children: null
            type: string
        selected: false
        title: æ•°æ®å¤„ç†
        type: code
        variables:
        - value_selector:
          - '1755013697903'
          - structured_output
          - name
          value_type: object
          variable: nameArg
        - value_selector:
          - '1755333812200'
          - structured_output
          - main_character
          value_type: object
          variable: maincharacterArg
        - value_selector:
          - '1755333812200'
          - structured_output
          - others
          value_type: object
          variable: othersArg
        - value_selector:
          - '1755334965838'
          - structured_output
          - events
          value_type: object
          variable: eventsArg
        - value_selector:
          - '1755345336430'
          - structured_output
          - firstmsg
          value_type: object
          variable: firstmsgArg
        - value_selector:
          - env
          - S3_REGION
          value_type: string
          variable: S3_REGION
        - value_selector:
          - env
          - S3_BUCKET_NAME
          value_type: string
          variable: S3_BUCKET_NAME
        - value_selector:
          - env
          - S3_ENDPOINT
          value_type: string
          variable: S3_ENDPOINT
        - value_selector:
          - env
          - S3_SECRET_ACCESS_KEY
          value_type: secret
          variable: S3_SECRET_ACCESS_KEY
        - value_selector:
          - env
          - S3_ACCESS_KEY_ID
          value_type: secret
          variable: S3_ACCESS_KEY_ID
      height: 53
      id: '1755349739661'
      position:
        x: 1344.242398153081
        y: 609.857142857143
      positionAbsolute:
        x: 1344.242398153081
        y: 609.857142857143
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        code: "\ndef main() -> dict:\n    return {\n        \"name\":\"111\",\n  \
          \      \"mc\": {\"name\": \"ä¸»è§’\", \"description\": \"ä¸»è§’çš„æè¿°\"},\n       \
          \ \"others\": [{\"name\": \"é…è§’1\", \"description\": \"é…è§’1çš„æè¿°\"}, {\"name\"\
          : \"é…è§’2\", \"description\": \"é…è§’2çš„æè¿°\"}],\n        \"events\": [{\"key\"\
          : [\"event1\"], \"msg\": \"äº‹ä»¶1çš„æè¿°\"}, {\"key\": [\"event2\"], \"msg\": \"\
          äº‹ä»¶2çš„æè¿°\"}],\n        \"firstmsg\":[\"ä½ å¥½ï¼Œæ¬¢è¿æ¥åˆ°é…’é¦†ï¼\", \"è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„ï¼Ÿ\"]\n \
          \   }\n"
        code_language: python3
        desc: ''
        outputs:
          events:
            children: null
            type: array[object]
          firstmsg:
            children: null
            type: array[string]
          mc:
            children: null
            type: object
          name:
            children: null
            type: string
          others:
            children: null
            type: array[object]
        selected: false
        title: debug
        type: code
        variables: []
      height: 53
      id: '1755394568320'
      position:
        x: 1072.894540867587
        y: 118.13340637245705
      positionAbsolute:
        x: 1072.894540867587
        y: 118.13340637245705
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        code: "import json\nfrom dataclasses import asdict, dataclass\nfrom typing\
          \ import List, Dict, Any, Optional\nfrom datetime import datetime\nimport\
          \ hmac\nimport hashlib\n\nimport os\nimport requests\nimport urllib.parse\n\
          \n#é…’é¦†æ•°æ®\n@dataclass\nclass RegexScript: #æ­£åˆ™\n    id: str\n    scriptName:\
          \ str\n    findRegex: str\n    replaceString: str\n    trimStrings: List[str]\n\
          \    placement: List[int]\n    disabled: bool\n    markdownOnly: bool\n\
          \    promptOnly: bool\n    runOnEdit: bool\n    substituteRegex: int\n \
          \   minDepth: Optional[int] = None\n    maxDepth: Optional[int] = None\n\
          \n@dataclass\nclass CharacterBookEntryExtensions:  # ä¸–ç•Œä¹¦å•ä¸€æ¡ç›®çš„ä¿¡æ¯ï¼Œæœ‰å¾ˆå¤šç”¨ä¸ä¸Š\n\
          \    position: int\n    exclude_recursion: bool\n    display_index: int\n\
          \    probability: int\n    useProbability: bool\n    depth: int\n    selectiveLogic:\
          \ int\n    group: str\n    group_override: bool\n    group_weight: int\n\
          \    prevent_recursion: bool\n    delay_until_recursion: bool\n    scan_depth:\
          \ Optional[int] = None\n    match_whole_words: bool = False\n    use_group_scoring:\
          \ bool = False\n    case_sensitive: bool = False\n    automation_id: str\
          \ = \"\"\n    role: int = 0\n    vectorized: bool = False\n    sticky: int\
          \ = 0\n    cooldown: int = 0\n    delay: int = 0\n    match_persona_description:\
          \ bool = False\n    match_character_description: bool = False\n    match_character_personality:\
          \ bool = False\n    match_character_depth_prompt: bool = False\n    match_scenario:\
          \ bool = False\n    match_creator_notes: bool = False\n\n@dataclass\nclass\
          \ CharacterBookEntry:\n    id: int\n    keys: List[str] #å…³é”®è¯\n    secondary_keys:\
          \ List[str] #å¯é€‰è¿‡æ»¤å™¨(stæ–‡æœ¬æè¿°å¦‚æ­¤)\n    comment: str   #æè¿°\n    content: str \
          \  #æ¿€æ´»åæ›¿æ¢çš„æ–‡æœ¬\n    constant: bool  # æ˜¯å¦æ°¸ä¹…æ¿€æ´»,ä¸ºtrueå°±ä¸ç®¡æ­£åˆ™æ˜¯å¦ç”Ÿæ•ˆï¼Œéƒ½ä¼šæ’å…¥ä¸–ç•Œä¹¦\n    selective:\
          \ bool #æ°¸ä¹…ä¸ºtrueï¼Ÿä¸çŸ¥é“å«ä¹‰\n    insertion_order: int  #åŒä¸€ä¸ªæ’å…¥ä½ç½®çš„é¡ºåºï¼Œæ•°å­—å°çš„åœ¨ä¸Šé¢\n \
          \   enabled: bool    # æ˜¯å¦åº”ç”¨\n    position: str    # å‡ ä¸ªä½ç½®æšä¸¾ after_char\n\
          \    use_regex: bool  # å¤§å¤šä¸ºtrue\n    #extensions: CharacterBookEntryExtensions\n\
          \n@dataclass\nclass CharacterBook:\n    entries: List[CharacterBookEntry]\n\
          \    name: str\n\n@dataclass\nclass Extensions:\n    talkativeness: str\n\
          \    fav: bool\n    world: str\n    depth_prompt: Dict[str, Any]\n    regex_scripts:\
          \ List[RegexScript]\n\n@dataclass\nclass Data:\n    name: str\n    first_mes:\
          \ str\n    alternate_greetings: List[str]\n    #extensions: Extensions\n\
          \    group_only_greetings: List[str]\n    character_book: CharacterBook\n\
          \n@dataclass\nclass CharaCardV3:\n    name: str\n    first_mes: str\n  \
          \  talkativeness: str\n    spec: str\n    spec_version: str\n    data: Data\n\
          \    create_date: str\n\n#è‡ªå®šä¹‰æ•°æ®\n@dataclass\nclass role:\n    name: str\n\
          \    desc: str\n\n@dataclass\nclass ent:\n    key: List[str]\n    msg: str\n\
          \ndef main(nameArg: str, maincharacterArg: dict, othersArg: list, eventsArg:\
          \ list, firstmsgArg: list, S3_REGION: str, S3_BUCKET_NAME: str, S3_ENDPOINT:\
          \ str, S3_SECRET_ACCESS_KEY, S3_ACCESS_KEY_ID) -> dict:\n    name=nameArg\n\
          \    maincharacter = role(\n        name=maincharacterArg['name'],\n   \
          \     desc=maincharacterArg['description']\n    )\n\n    others = [role(name=o['name'],\
          \ desc=o['description']) for o in othersArg]\n    events =[]\n    #events\
          \ = [ent(key=e['key'], msg=e['msg']) for e in eventsArg]\n    firmsg = firstmsgArg\n\
          \n        #ç”Ÿæˆä¸–ç•Œä¹¦\n    i = 0\n    cbes:List[CharacterBookEntry] = []\n  \
          \  cbe = CharacterBookEntry(\n            id=i,\n            keys=[],\n\
          \            secondary_keys=[],\n            comment=\"è§’è‰²èƒŒæ™¯\",\n       \
          \     content=maincharacter.name+\":\"+maincharacter.desc,\n           \
          \ constant=True,\n            selective=True,\n            insertion_order=100,\n\
          \            enabled=True,\n            position=\"after_char\",\n     \
          \       use_regex=True,\n            )\n    cbes.append(cbe)\n    i = i\
          \ + 1\n    for other in others:\n        cbes.append(CharacterBookEntry(\n\
          \            id=i,\n            keys=[other.name],\n            secondary_keys=[],\n\
          \            comment=\"è§’è‰²èƒŒæ™¯\",\n            content=other.name+\":\"+other.desc,\n\
          \            constant=True,\n            selective=True,\n            insertion_order=100,\n\
          \            enabled=True,\n            position=\"after_char\",\n     \
          \       use_regex=True,\n        ))\n        i = i + 1\n    for event in\
          \ events:\n        cbes.append(CharacterBookEntry(\n            id=i,\n\
          \            keys=event.key,\n            secondary_keys=[],\n         \
          \   comment=f\"äº‹ä»¶{event.key.get('0', 'æœªçŸ¥')}\",\n            content=event.msg,\n\
          \            constant=True,\n            selective=True,\n            insertion_order=100,\n\
          \            enabled=True,\n            position=\"after_char\",\n     \
          \       use_regex=True,\n        ))\n        i = i + 1\n    \n    data =\
          \ Data(\n        name=name,\n        first_mes=firmsg[0],\n        alternate_greetings=[msg\
          \ for msg in firmsg[1:]],\n        group_only_greetings=[],\n        character_book=CharacterBook(\n\
          \            entries=cbes,\n            name=f\"ä¸–ç•Œä¹¦:{name}\"\n        ),\n\
          \    )\n    current_time = datetime.now()\n    formatted_time = current_time.strftime(\"\
          %Y-%m-%d %H:%M:%S\")\n    card = CharaCardV3(\n        name=name,\n    \
          \    first_mes=firmsg[0],\n        talkativeness=\"0.5\",\n        spec=\"\
          chara_card_v3\",\n        spec_version=\"3.0\",\n        data=data,\n  \
          \      create_date= formatted_time\n    )\n    s = json.dumps(asdict(card),\
          \ ensure_ascii=False)\n    # ret: Output = {\n    #     \"name\": name,\n\
          \    #     \"first_mes\": firmsg[0],\n    #     \"talkativeness\":\"0.5\"\
          ,\n    #     \"spec\":\"chara_card_v3\",\n    #     \"spec_version\":\"\
          3.0\",\n    #     \"data\":s,\n    #     \"create_date\": formatted_time,\n\
          \    # }\n    access_key = S3_ACCESS_KEY_ID\n    secret_key = S3_SECRET_ACCESS_KEY\n\
          \    endpoint = S3_ENDPOINT\n    bucket = S3_BUCKET_NAME\n    region = S3_REGION\n\
          \    if access_key is None:\n        raise EnvironmentError(f\"ç¯å¢ƒå˜é‡æœªè®¾ç½®æˆ–ä¸ºç©º\"\
          )\n    s3 = S3Client(\n        access_key=access_key,\n        secret_key=secret_key,\n\
          \        endpoint=endpoint,\n        bucket=bucket,\n        region=region,\n\
          \    )\n    \n    data_bytes = s.encode('utf-8') \n    s3_key = f\"card/{name}_{datetime.utcnow().isoformat()}.json\"\
          \n    # ä¸Šä¼ å¹¶è·å–URL\n    if s3.put_object(s3_key, data_bytes):\n        url\
          \ = (s3.generate_presigned_url(s3_key))\n    else:\n        raise RuntimeError(f\"\
          S3 upload failed{access_key}\")\n    return {\n        \"url\": url\n  \
          \  }\n\n\nclass S3Client:\n    def __init__(self, access_key, secret_key,\
          \ endpoint, bucket, region=\"cn-guangzhou\"):\n        self.access_key =\
          \ access_key\n        self.secret_key = secret_key\n        self.bucket\
          \ = bucket\n        self.endpoint = endpoint.replace('https://', '').replace('http://',\
          \ '')\n        self.service = 's3'\n        self.region = region or \"cn-guangzhou\"\
          \n\n    def _get_signature_key(self, date_stamp):\n        k_date = hmac.new(f\"\
          AWS4{self.secret_key}\".encode('utf-8'), date_stamp.encode('utf-8'), hashlib.sha256).digest()\n\
          \        k_region = hmac.new(k_date, self.region.encode('utf-8'), hashlib.sha256).digest()\n\
          \        k_service = hmac.new(k_region, self.service.encode('utf-8'), hashlib.sha256).digest()\n\
          \        return hmac.new(k_service, b\"aws4_request\", hashlib.sha256).digest()\n\
          \n    def _build_canonical_request(self, method, key, headers, signed_headers,\
          \ payload_hash):\n        # 1. HTTPæ–¹æ³•\n        canonical_request = f\"{method}\\\
          n\"\n        \n        # 2. CanonicalURI (URLç¼–ç è·¯å¾„)\n        canonical_request\
          \ += f\"/{urllib.parse.quote(key, safe='/')}\\n\"\n        \n        # 3.\
          \ CanonicalQueryString (ç©ºå­—ç¬¦ä¸²ï¼Œæ— æŸ¥è¯¢å‚æ•°)\n        canonical_request += \"\\n\"\
          \n        \n        # 4. CanonicalHeaders (æŒ‰å°å†™å­—æ®µåæ’åº)\n        sorted_headers\
          \ = sorted(headers.items(), key=lambda x: x[0].lower())\n        for header_name,\
          \ header_value in sorted_headers:\n            canonical_request += f\"\
          {header_name.lower()}:{header_value}\\n\"\n        \n        # 5. SignedHeaders\
          \ (æ’åºçš„å¤´éƒ¨åˆ—è¡¨)\n        canonical_request += \"\\n\"\n        canonical_request\
          \ += signed_headers + \"\\n\"\n        \n        # 6. HashedPayload\n  \
          \      canonical_request += payload_hash\n        \n        return canonical_request\n\
          \n    def _build_auth_header(self, method, key, headers, signed_headers,\
          \ payload_hash):\n        datestamp = datetime.utcnow().strftime('%Y%m%d')\n\
          \        amz_date = headers['x-amz-date']\n        \n        # 1. æ„å»ºCanonicalRequest\n\
          \        canonical_request = self._build_canonical_request(\n          \
          \  method, key, headers, signed_headers, payload_hash\n        )\n     \
          \   \n        # 2. åˆ›å»ºè¦ç­¾åçš„å­—ç¬¦ä¸²\n        algorithm = 'AWS4-HMAC-SHA256'\n \
          \       credential_scope = f\"{datestamp}/{self.region}/{self.service}/aws4_request\"\
          \n        \n        string_to_sign = (\n            f\"{algorithm}\\n\"\n\
          \            f\"{amz_date}\\n\"\n            f\"{credential_scope}\\n\"\n\
          \            f\"{hashlib.sha256(canonical_request.encode('utf-8')).hexdigest()}\"\
          \n        )\n        \n        # 3. è®¡ç®—ç­¾å\n        signing_key = self._get_signature_key(datestamp)\n\
          \        signature = hmac.new(signing_key, string_to_sign.encode('utf-8'),\
          \ hashlib.sha256).hexdigest()\n        \n        return (\n            f\"\
          {algorithm} Credential={self.access_key}/{credential_scope}, \"\n      \
          \      f\"SignedHeaders={signed_headers}, Signature={signature}\"\n    \
          \    )\n\n    def put_object(self, key, data, content_type='application/json'):\n\
          \        # å‡†å¤‡è¯·æ±‚å‚æ•°\n        host = f\"{self.bucket}.{self.endpoint}\"\n \
          \       url = f\"https://{host}/{urllib.parse.quote(key, safe='/')}\"\n\
          \        amz_date = datetime.utcnow().strftime('%Y%m%dT%H%M%SZ')\n     \
          \   payload_hash = hashlib.sha256(data).hexdigest()\n        \n        #\
          \ å¿…é¡»åŒ…å«æ‰€æœ‰ç­¾åå¤´\n        headers = {\n            'Host': host,\n          \
          \  'Content-Type': content_type,\n            'x-amz-date': amz_date,\n\
          \            'x-amz-content-sha256': payload_hash\n        }\n        \n\
          \        # æ’åºçš„ç­¾åå¤´éƒ¨åˆ—è¡¨\n        signed_headers = ';'.join(sorted(header.lower()\
          \ for header in headers.keys()))\n        \n        # ç”Ÿæˆè®¤è¯å¤´\n        auth_header\
          \ = self._build_auth_header(\n            'PUT', key, headers, signed_headers,\
          \ payload_hash\n        )\n        headers['Authorization'] = auth_header\n\
          \        \n        # å‘é€è¯·æ±‚\n        response = requests.put(url, data=data,\
          \ headers=headers)\n        return response.status_code == 200\n\n    def\
          \ generate_presigned_url(self, key, expires=3600):\n        host = f\"{self.bucket}.{self.endpoint}\"\
          \n        datestamp = datetime.utcnow().strftime('%Y%m%d')\n        amz_date\
          \ = datetime.utcnow().strftime('%Y%m%dT%H%M%SZ')\n        credential_scope\
          \ = f\"{datestamp}/{self.region}/s3/aws4_request\"\n        \n        #\
          \ æŸ¥è¯¢å‚æ•°\n        query_params = {\n            'X-Amz-Algorithm': 'AWS4-HMAC-SHA256',\n\
          \            'X-Amz-Credential': f\"{self.access_key}/{credential_scope}\"\
          ,\n            'X-Amz-Date': amz_date,\n            'X-Amz-Expires': str(expires),\n\
          \            'X-Amz-SignedHeaders': 'host',\n        }\n        \n     \
          \   # è§„èŒƒæŸ¥è¯¢å­—ç¬¦ä¸²\n        canonical_querystring = '&'.join(\n            f\"\
          {k}={urllib.parse.quote(v, safe='')}\" \n            for k, v in sorted(query_params.items())\n\
          \        )\n        \n        # è§„èŒƒè¯·æ±‚\n        canonical_request = (\n  \
          \          f\"GET\\n\"\n            f\"/{urllib.parse.quote(key, safe='/')}\\\
          n\"\n            f\"{canonical_querystring}\\n\"\n            f\"host:{host}\\\
          n\\n\"\n            f\"host\\n\"\n            f\"UNSIGNED-PAYLOAD\"\n  \
          \      )\n        \n        # åˆ›å»ºè¦ç­¾åçš„å­—ç¬¦ä¸²\n        string_to_sign = (\n  \
          \          f\"AWS4-HMAC-SHA256\\n\"\n            f\"{amz_date}\\n\"\n  \
          \          f\"{credential_scope}\\n\"\n            f\"{hashlib.sha256(canonical_request.encode('utf-8')).hexdigest()}\"\
          \n        )\n        \n        # è®¡ç®—ç­¾å\n        signing_key = self._get_signature_key(datestamp)\n\
          \        signature = hmac.new(signing_key, string_to_sign.encode('utf-8'),\
          \ hashlib.sha256).hexdigest()\n        \n        return f\"https://{host}/{urllib.parse.quote(key,\
          \ safe='/')}?{canonical_querystring}&X-Amz-Signature={signature}\"\n\n\n"
        code_language: python3
        desc: ''
        outputs:
          url:
            children: null
            type: string
        selected: false
        title: æ•°æ®å¤„ç† (1)
        type: code
        variables:
        - value_selector:
          - '1755394568320'
          - name
          value_type: string
          variable: nameArg
        - value_selector:
          - '1755394568320'
          - mc
          value_type: object
          variable: maincharacterArg
        - value_selector:
          - '1755394568320'
          - others
          value_type: array[object]
          variable: othersArg
        - value_selector:
          - '1755394568320'
          - events
          value_type: array[object]
          variable: eventsArg
        - value_selector:
          - '1755394568320'
          - firstmsg
          value_type: array[string]
          variable: firstmsgArg
        - value_selector:
          - env
          - S3_REGION
          value_type: string
          variable: S3_REGION
        - value_selector:
          - env
          - S3_BUCKET_NAME
          value_type: string
          variable: S3_BUCKET_NAME
        - value_selector:
          - env
          - S3_ENDPOINT
          value_type: string
          variable: S3_ENDPOINT
        - value_selector:
          - env
          - S3_SECRET_ACCESS_KEY
          value_type: secret
          variable: S3_SECRET_ACCESS_KEY
        - value_selector:
          - env
          - S3_ACCESS_KEY_ID
          value_type: secret
          variable: S3_ACCESS_KEY_ID
      height: 53
      id: '17553986203320'
      position:
        x: 1344.242398153081
        y: 118.13340637245705
      positionAbsolute:
        x: 1344.242398153081
        y: 118.13340637245705
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        author: Dify
        desc: ''
        height: 88
        selected: false
        showAuthor: true
        text: '{"root":{"children":[{"children":[{"detail":0,"format":0,"mode":"normal","style":"","text":"æµ‹è¯•éå¤§æ¨¡å‹éƒ¨åˆ†","type":"text","version":1}],"direction":"ltr","format":"","indent":0,"type":"paragraph","version":1,"textFormat":0,"textStyle":""}],"direction":"ltr","format":"","indent":0,"type":"root","version":1}}'
        theme: blue
        title: ''
        type: ''
        width: 240
      height: 88
      id: '1755398991129'
      position:
        x: 1072.894540867587
        y: 15.112065500389576
      positionAbsolute:
        x: 1072.894540867587
        y: 15.112065500389576
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom-note
      width: 240
    - data:
        cases:
        - case_id: 'true'
          conditions:
          - comparison_operator: is
            id: 042fa2d5-660d-4f40-962a-e3749e046ede
            value: 'true'
            varType: string
            variable_selector:
            - '1754406660427'
            - debug
          id: 'true'
          logical_operator: and
        desc: ''
        selected: false
        title: æ¡ä»¶åˆ†æ”¯
        type: if-else
      height: 125
      id: '1755399127965'
      position:
        x: -186.9441851036331
        y: 316.0701915835626
      positionAbsolute:
        x: -186.9441851036331
        y: 316.0701915835626
      selected: true
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        desc: ''
        outputs:
        - value_selector:
          - '17553986203320'
          - url
          value_type: string
          variable: url
        selected: false
        title: ç»“æŸ 2
        type: end
      height: 90
      id: '1755399316678'
      position:
        x: 1652.9107761540793
        y: 118.13340637245705
      positionAbsolute:
        x: 1652.9107761540793
        y: 118.13340637245705
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    viewport:
      x: -744.4661961055946
      y: 429.71220730093415
      zoom: 0.7772031217786937
